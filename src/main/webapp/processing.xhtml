<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"></meta>

        <title>Ring</title>
        <h:outputScript library="js" name="jquery-1.8.1.min.js" />
        <h:outputScript library="js" name="processing-1.4.1.js" />

        <script type="text/javascript">
            //<![CDATA[
            $(function(){
                
                var timer = 0,
                timeout = 3000,
                memPage = setInterval(function () {
                    var sketchPage = Processing.getInstanceById("canvasPage");
                    if (sketchPage) {
                        console.log("SKETCH PAGE HAS LOADED");
                        clearInterval(memPage);
                        var json = '#{processingBean.json}';
                        var data = $.parseJSON(json);
                        if(data) {
                            for(i=0; i<data.length; i++) {
                                var segment = data[i];
                                sketchPage.addSegment(segment.label, segment.count,segment.isMain);
                            }
                        }
                    } else {
                        timer += 10;
                        if (timer > timeout) {
                            console.log("FAILED TO LOAD SKETCH PAGE");
                            clearInterval(memPage);
                        }
                    }
                }, 10);

                memPDF = setInterval(function () {
                    var sketchPDF = Processing.getInstanceById("canvasPDF");
                    if (sketchPDF) {
                        console.log("SKETCH PDF HAS LOADED");
                        clearInterval(memPDF);
                        var json = '#{processingBean.json}';
                        var data = $.parseJSON(json);
                        if(data) {
                            for(i=0; i<data.length; i++) {
                                var segment = data[i];
                                sketchPDF.addSegment(segment.label, segment.count,segment.isMain);
                            }
                        }
                    } else {
                        timer += 10;
                        if (timer > timeout) {
                            console.log("FAILED TO LOAD SKETCH");
                            clearInterval(memPDF);
                        }
                    }
                }, 10);
            }); //end ready

            //]]>
        </script>

        <script type="text/javascript">
            function handleOutcome(event){
                var canvas = document.getElementById("canvasPDF");
                var dataURL    = canvas.toDataURL("image/png");
                var hidden = document.getElementById('form:dataURL');
                hidden.value = dataURL;

            }
        </script>

    </h:head>
    <h:body>

        
        <h:form id ="form">
            <h:inputHidden id="dataURL" value="#{fileDownloadController.dataURL}" />

            <p:commandButton id="downloadLink" value="Download" ajax="false" onclick ="handleOutcome();"   
                             icon="ui-icon-arrowthichk-s">  
                <p:fileDownload value="#{fileDownloadController.file}" />  
            </p:commandButton>  
        </h:form>
        <canvas id ="canvasPage" data-processing-sources="processingSketchForScreen.pde"></canvas>
        <canvas id ="canvasPDF" style="display:none" data-processing-sources="processingSketchForPDF.pde"></canvas>

    </h:body>
</html>

