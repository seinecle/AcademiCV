<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"></meta>

        <title>AcademiCV</title>
        <h:outputScript library="js" name="processing-1.4.1.js" />
        <h:outputScript library="js" name="kinetic-v4.0.2.min.js" />
        <h:outputScript library="js" name="kineticCircleJS.js" />

        <script type="text/javascript">
            //<![CDATA[

            $(function(){

                var json = '#{reportBean.json}';
                if (json == null){
                    return;
                }
                addSegments(json);
            


                var timer = 0,
                timeout = 3000,

                memPDF = setInterval(function () {
                    var sketchPDF = Processing.getInstanceById("canvasPDF");
                    if (sketchPDF) {
                        console.log("SKETCH PDF HAS LOADED");
                        clearInterval(memPDF);
                        var json = '#{reportBean.json}';
                        var data = $.parseJSON(json);
                        if(data) {
                            for(i=0; i<data.length; i++) {
                                var segment = data[i];
                                sketchPDF.addSegment(segment.label, segment.count,segment.isMain);
                            }
                        }
                    } else {
                        timer += 10;
                        if (timer > timeout) {
                            console.log("FAILED TO LOAD SKETCH");
                            clearInterval(memPDF);
                        }
                    }
                }, 10);
                
                
            }); //end ready

            //]]>
        </script>

        <script type="text/javascript">
            function handleOutcome(event){
                var canvas = document.getElementById("canvasPDF");
                var dataURL    = canvas.toDataURL("image/jpeg",0.9);
                var hidden = document.getElementById('form:dataURL');
                hidden.value = dataURL;

            }
        </script>

    </h:head>
    <h:body>


        <h1>academiCV for #{controllerBean.forename} #{controllerBean.surname}</h1>
        <p>#{controllerBean.getSearch().mostRecentAffiliation}</p>

        <h:form id ="form">
            <h:inputHidden id="dataURL" value="#{fileDownloadController.dataURL}" />

            <p:commandButton id="downloadLink" value="Download" ajax="false" onclick ="handleOutcome();"   
                             icon="ui-icon-arrowthichk-s">  
                <p:fileDownload value="#{fileDownloadController.file}" />  
            </p:commandButton>  
            <br></br>
            <p:commandButton value="Feedback? Here!" onclick="bar.show()"/>  
            <br></br>
            <p:commandButton value="New Search" action="index?faces-redirect=true" rendered="#{!controllerBean.wereThereCoAuthorsFound()}" />  

        </h:form>
        <p:notificationBar position="bottom" effect="slide" widgetVar="bar">  
            <h:outputText value="Any comment you have, really!" style=" font-size:15px;" />  
            <h:inputText value="#{controllerBean.feedback}"/>  
        </p:notificationBar>  

        <div style="#{controllerBean.wereThereCoAuthorsFound()}margin-left: auto; margin-right: auto;text-align: center;width:800px">
            <p><b>(see also the report below the circle)</b></p>
        </div>

        <div id="container" style="#{controllerBean.wereThereCoAuthorsFound()}margin-left: auto; margin-right: auto;width:900px"></div>
        <div style="#{controllerBean.wereThereCoAuthorsFound()}margin-left: auto; margin-right: auto;text-align: center;width:800px">
            <p><b>Do you spot some errors?</b> Click on the "previous page" button of your browser to make edits.</p>
        </div>


        <div id ="laius">
            <p></p>
            <h:outputText styleClass="ui-widget"  value="#{reportBean.getGeneralLaius()}" escape="false" /><br></br>
            <h:outputText styleClass="ui-widget"  value="#{reportBean.getAge()}" escape="false" /><br></br>
            <h:outputText styleClass="ui-widget"  value="#{reportBean.getMostFrequentSource()}" escape="false" />
            <h:outputText styleClass="ui-widget"  value="#{reportBean.getMostFrequentCoAuthors()}" escape="false" />
            <h:outputText styleClass="ui-widget"  value="#{reportBean.NYTLaius}" escape="false" />

        </div>




        <h:form id="form2" prependId="false">
            <p:remoteCommand name="sendNameClicked" actionListener="#{reportBean.passName}"/>
            <p:remoteCommand name="updateDialog" update=":form3:dialogBox" oncomplete="cd.show();"/>
        </h:form>
        <h:form id="form3">
            <p:confirmDialog id ="dialogBox" message= "#{reportBean.getClickedAuthorLaius()}"
                             header="#{reportBean.nameClicked}#{reportBean.authorClicked.mostRecentAffiliation}"
                             widgetVar="cd"
                             severity="info"
                             >
                <h:outputText styleClass="ui-widget"  value="" escape="false" />
                <p:commandButton value="Draw the ring of #{reportBean.obtainFullName()}?" actionListener ="#{controllerBean.prepareNewSearch()}" action ="index?faces-redirect=true" oncomplete="cd.hide();"/>
                <p:commandButton value="No, stay on this page" onclick="cd.hide();" type="button" />
            </p:confirmDialog>
        </h:form>

        <p:notificationBar position="bottom" effect="slide" widgetVar="bar">  
            <h:form>
                <h:outputText value="Any comment you have, really!" style=" font-size:15px;" /><br></br>  
                <p:inputTextarea value="#{controllerBean.feedback}" rows="2" cols="90" />
                <p:commandButton value="Save" onclick="bar.hide();" type="button"/>  
            </h:form>
        </p:notificationBar>  





        <canvas id ="canvasPDF" style="display:none" data-processing-sources="processingSketchForPDF.pde"></canvas>



    </h:body>
</html>

